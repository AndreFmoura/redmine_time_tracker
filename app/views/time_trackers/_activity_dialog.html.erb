<%= javascript_tag render :partial => 'tt_overview/time_tracker', :formats => [:js] %>
<%
   activities = time_tracker.project_id.nil? ? TimeEntryActivity.shared.active.all : Project.visible.where(:id => time_tracker.project_id).first().activities
   options = options_from_collection_for_select(activities, :id, :name).split("\n").join("")
   select = select_tag :tt_activity, options, {:include_blank => true, :onchange => 'updateActivity()'}
   centered = content_tag :div, select, :class => 'center'
   desc = content_tag :p, l(:tt_activity_dialog_description)
%>
<script type="text/javascript">
    function updateActivity(val) {
        if (typeof(val) === 'undefined') {
            val = $('#tt_activity').val();
        } else {
            $('#tt_activity').val(val);
        }
        $.ajax({url: base_url() + '/time_trackers/update?key=<%= User.current.api_key %>&time_tracker[activity_id]=' + val,
            type: 'PUT'
        });
    }
    function showDialog() {
        var $dialog = $('#dialog')
        if ($dialog.length == 0) {
            $('<div/>', {id: 'dialog', title: '<%= l(:tt_activity_dialog_title)%>'})
                    .appendTo('body')
                    .append('<%=content_tag :div, desc + centered%>')
                    .dialog({
                        autoOpen: true,
                        resizable: false,
                        draggable: false,
                        modal: true,
                        width: 300,
                        buttons: [
                            {
                                id: "tt_activity_dialog_stop",
                                click: function () {
                                    $(this).dialog("close");
                                }
                            },
                            {
                                text: "<%= l(:button_cancel)%>",
                                click: function () {
                                    $(this).dialog("close");
                                    updateActivity('<%= time_tracker.activity_id%>');

                                }
                            }
                        ],
                        create: function () {
                            $('#tt_activity_dialog_stop .ui-button-text').replaceWith('<%=link_to stop_title,{:controller => 'time_trackers', :action => 'stop'},:data => {:type => 'html'}, :class => 'ui-button-text tt_dialog_stop', :remote => remote%>');
                        }
                    })
        } else {
            $dialog.dialog('open')
        }

    }
    $(document).ready(function () {
        $(document).on('click', '.tt_stop', function (e) {
            showDialog();
            if (typeof(contextMenuHide) === typeof(Function)) {
                contextMenuHide();
            }
            e.preventDefault();
        });
    });
</script>
